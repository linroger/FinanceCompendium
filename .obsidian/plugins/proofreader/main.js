/* THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the GitHub repository of this plugin. */

"use strict";var z=Object.defineProperty;var pe=Object.getOwnPropertyDescriptor;var ge=Object.getOwnPropertyNames;var he=Object.prototype.hasOwnProperty;var ve=(n,e)=>{for(var t in e)z(n,t,{get:e[t],enumerable:!0})},me=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ge(e))!he.call(n,i)&&i!==t&&z(n,i,{get:()=>e[i],enumerable:!(r=pe(e,i))||r.enumerable});return n};var we=n=>me(z({},"__esModule",{value:!0}),n);var Ae={};ve(Ae,{default:()=>W});module.exports=we(Ae);var de=require("obsidian");var E=require("obsidian");function F(n){return n.replace(/~~([^=~]+)~~/g,"$1").replace(/==[^=~]+==/g,"")}function ye(n){return n.replace(/==([^=~]+)==/g,"$1").replace(/~~[^=~]+~~/g,"")}function ee(n,e){return(e==="accept"?ye(n):F(n)).replace(/ {2}(?!\n)/g," ").replace(/ ([,.:;—–!?'"])/g,"$1")}function K(n,e){let t=n.posToOffset(e),r=n.cm.coordsAtPos(t);if(!r)return!1;let i=n.getScrollInfo();return r.top<i.clientHeight&&r.top>0}function R(n,e){let t=n.getSelection(),r=n.getCursor(),i=t?"selection":"paragraph",o=t||n.getLine(r.line);if(!o.match(/==|~~/)){new E.Notice(`There are no highlights or strikethroughs in the ${i}.`,3e3);return}let s=ee(o,e);t?n.replaceSelection(s):n.setLine(r.line,s);let a=o.length-s.length;r.ch=Math.max(r.ch-a,0),n.setCursor(r)}function U(n,e){let t=n.getCursor(),r=n.posToOffset(t)+1,i=n.getValue();if(!K(n,t)){new E.Notice("Cursor is not visible. Scrolled to the cursor instead."),n.scrollIntoView({from:t,to:t},!0);return}let s=n.posToOffset({line:t.line,ch:0}),a="",u=0,l=0;for(;;){let g=i.slice(s).match(/ ?(==[^~=]*?==|~~[^~=]*~~).?/);if(!g){new E.Notice("There are no highlights or strikethroughs until the end of the note.",3e3);return}a=g[0],u=s+g.index,l=u+a.length;let p=r>=u&&r<=l,h=r<=u;if(p||h)break;s=l}let f=n.offsetToPos(u),c=n.offsetToPos(l);if(!K(n,c)){new E.Notice("Next suggestion not visible. Scrolled to next suggestion instead."),n.scrollIntoView({from:f,to:c},!0),n.setCursor(f);return}let v=ee(a,e);n.replaceRange(v,f,c),n.setCursor(f)}function m(){}m.prototype={diff:function(e,t){var r,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},o=i.callback;typeof i=="function"&&(o=i,i={});var s=this;function a(d){return d=s.postProcess(d,i),o?(setTimeout(function(){o(d)},0),!0):d}e=this.castInput(e,i),t=this.castInput(t,i),e=this.removeEmpty(this.tokenize(e,i)),t=this.removeEmpty(this.tokenize(t,i));var u=t.length,l=e.length,f=1,c=u+l;i.maxEditLength!=null&&(c=Math.min(c,i.maxEditLength));var v=(r=i.timeout)!==null&&r!==void 0?r:1/0,g=Date.now()+v,p=[{oldPos:-1,lastComponent:void 0}],h=this.extractCommon(p[0],t,e,0,i);if(p[0].oldPos+1>=l&&h+1>=u)return a(ne(s,p[0].lastComponent,t,e,s.useLongestToken));var L=-1/0,S=1/0;function b(){for(var d=Math.max(L,-f);d<=Math.min(S,f);d+=2){var T=void 0,C=p[d-1],P=p[d+1];C&&(p[d-1]=void 0);var D=!1;if(P){var Z=P.oldPos-d;D=P&&0<=Z&&Z<u}var _=C&&C.oldPos+1<l;if(!D&&!_){p[d]=void 0;continue}if(!_||D&&C.oldPos<P.oldPos?T=s.addToPath(P,!0,!1,0,i):T=s.addToPath(C,!1,!0,1,i),h=s.extractCommon(T,t,e,d,i),T.oldPos+1>=l&&h+1>=u)return a(ne(s,T.lastComponent,t,e,s.useLongestToken));p[d]=T,T.oldPos+1>=l&&(S=Math.min(S,d-1)),h+1>=u&&(L=Math.max(L,d+1))}f++}if(o)(function d(){setTimeout(function(){if(f>c||Date.now()>g)return o();b()||d()},0)})();else for(;f<=c&&Date.now()<=g;){var y=b();if(y)return y}},addToPath:function(e,t,r,i,o){var s=e.lastComponent;return s&&!o.oneChangePerToken&&s.added===t&&s.removed===r?{oldPos:e.oldPos+i,lastComponent:{count:s.count+1,added:t,removed:r,previousComponent:s.previousComponent}}:{oldPos:e.oldPos+i,lastComponent:{count:1,added:t,removed:r,previousComponent:s}}},extractCommon:function(e,t,r,i,o){for(var s=t.length,a=r.length,u=e.oldPos,l=u-i,f=0;l+1<s&&u+1<a&&this.equals(r[u+1],t[l+1],o);)l++,u++,f++,o.oneChangePerToken&&(e.lastComponent={count:1,previousComponent:e.lastComponent,added:!1,removed:!1});return f&&!o.oneChangePerToken&&(e.lastComponent={count:f,previousComponent:e.lastComponent,added:!1,removed:!1}),e.oldPos=u,l},equals:function(e,t,r){return r.comparator?r.comparator(e,t):e===t||r.ignoreCase&&e.toLowerCase()===t.toLowerCase()},removeEmpty:function(e){for(var t=[],r=0;r<e.length;r++)e[r]&&t.push(e[r]);return t},castInput:function(e){return e},tokenize:function(e){return Array.from(e)},join:function(e){return e.join("")},postProcess:function(e){return e}};function ne(n,e,t,r,i){for(var o=[],s;e;)o.push(e),s=e.previousComponent,delete e.previousComponent,e=s;o.reverse();for(var a=0,u=o.length,l=0,f=0;a<u;a++){var c=o[a];if(c.removed)c.value=n.join(r.slice(f,f+c.count)),f+=c.count;else{if(!c.added&&i){var v=t.slice(l,l+c.count);v=v.map(function(g,p){var h=r[f+p];return h.length>g.length?h:g}),c.value=n.join(v)}else c.value=n.join(t.slice(l,l+c.count));l+=c.count,c.added||(f+=c.count)}}return o}var Ie=new m;function te(n,e){var t;for(t=0;t<n.length&&t<e.length;t++)if(n[t]!=e[t])return n.slice(0,t);return n.slice(0,t)}function re(n,e){var t;if(!n||!e||n[n.length-1]!=e[e.length-1])return"";for(t=0;t<n.length&&t<e.length;t++)if(n[n.length-(t+1)]!=e[e.length-(t+1)])return n.slice(-t);return n.slice(-t)}function V(n,e,t){if(n.slice(0,e.length)!=e)throw Error("string ".concat(JSON.stringify(n)," doesn't start with prefix ").concat(JSON.stringify(e),"; this is a bug"));return t+n.slice(e.length)}function J(n,e,t){if(!e)return n+t;if(n.slice(-e.length)!=e)throw Error("string ".concat(JSON.stringify(n)," doesn't end with suffix ").concat(JSON.stringify(e),"; this is a bug"));return n.slice(0,-e.length)+t}function N(n,e){return V(n,e,"")}function H(n,e){return J(n,e,"")}function ie(n,e){return e.slice(0,xe(n,e))}function xe(n,e){var t=0;n.length>e.length&&(t=n.length-e.length);var r=e.length;n.length<e.length&&(r=n.length);var i=Array(r),o=0;i[0]=0;for(var s=1;s<r;s++){for(e[s]==e[o]?i[s]=i[o]:i[s]=o;o>0&&e[s]!=e[o];)o=i[o];e[s]==e[o]&&o++}o=0;for(var a=t;a<n.length;a++){for(;o>0&&n[a]!=e[o];)o=i[o];n[a]==e[o]&&o++}return o}var j="a-zA-Z0-9_\\u{C0}-\\u{FF}\\u{D8}-\\u{F6}\\u{F8}-\\u{2C6}\\u{2C8}-\\u{2D7}\\u{2DE}-\\u{2FF}\\u{1E00}-\\u{1EFF}",Le=new RegExp("[".concat(j,"]+|\\s+|[^").concat(j,"]"),"ug"),M=new m;M.equals=function(n,e,t){return t.ignoreCase&&(n=n.toLowerCase(),e=e.toLowerCase()),n.trim()===e.trim()};M.tokenize=function(n){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},t;if(e.intlSegmenter){if(e.intlSegmenter.resolvedOptions().granularity!="word")throw new Error('The segmenter passed must have a granularity of "word"');t=Array.from(e.intlSegmenter.segment(n),function(o){return o.segment})}else t=n.match(Le)||[];var r=[],i=null;return t.forEach(function(o){/\s/.test(o)?i==null?r.push(o):r.push(r.pop()+o):/\s/.test(i)?r[r.length-1]==i?r.push(r.pop()+o):r.push(i+o):r.push(o),i=o}),r};M.join=function(n){return n.map(function(e,t){return t==0?e:e.replace(/^\s+/,"")}).join("")};M.postProcess=function(n,e){if(!n||e.oneChangePerToken)return n;var t=null,r=null,i=null;return n.forEach(function(o){o.added?r=o:o.removed?i=o:((r||i)&&oe(t,i,r,o),t=o,r=null,i=null)}),(r||i)&&oe(t,i,r,null),n};function se(n,e,t){return t?.ignoreWhitespace!=null&&!t.ignoreWhitespace?Te(n,e,t):M.diff(n,e,t)}function oe(n,e,t,r){if(e&&t){var i=e.value.match(/^\s*/)[0],o=e.value.match(/\s*$/)[0],s=t.value.match(/^\s*/)[0],a=t.value.match(/\s*$/)[0];if(n){var u=te(i,s);n.value=J(n.value,s,u),e.value=N(e.value,u),t.value=N(t.value,u)}if(r){var l=re(o,a);r.value=V(r.value,a,l),e.value=H(e.value,l),t.value=H(t.value,l)}}else if(t)n&&(t.value=t.value.replace(/^\s*/,"")),r&&(r.value=r.value.replace(/^\s*/,""));else if(n&&r){var f=r.value.match(/^\s*/)[0],c=e.value.match(/^\s*/)[0],v=e.value.match(/\s*$/)[0],g=te(f,c);e.value=N(e.value,g);var p=re(N(f,g),v);e.value=H(e.value,p),r.value=V(r.value,f,p),n.value=J(n.value,f,f.slice(0,f.length-p.length))}else if(r){var h=r.value.match(/^\s*/)[0],L=e.value.match(/\s*$/)[0],S=ie(L,h);e.value=H(e.value,S)}else if(n){var b=n.value.match(/\s*$/)[0],y=e.value.match(/^\s*/)[0],d=ie(b,y);e.value=N(e.value,d)}}var ae=new m;ae.tokenize=function(n){var e=new RegExp("(\\r?\\n)|[".concat(j,"]+|[^\\S\\n\\r]+|[^").concat(j,"]"),"ug");return n.match(e)||[]};function Te(n,e,t){return ae.diff(n,e,t)}var X=new m;X.tokenize=function(n,e){e.stripTrailingCr&&(n=n.replace(/\r\n/g,`
`));var t=[],r=n.split(/(\n|\r\n)/);r[r.length-1]||r.pop();for(var i=0;i<r.length;i++){var o=r[i];i%2&&!e.newlineIsToken?t[t.length-1]+=o:t.push(o)}return t};X.equals=function(n,e,t){return t.ignoreWhitespace?((!t.newlineIsToken||!n.includes(`
`))&&(n=n.trim()),(!t.newlineIsToken||!e.includes(`
`))&&(e=e.trim())):t.ignoreNewlineAtEof&&!t.newlineIsToken&&(n.endsWith(`
`)&&(n=n.slice(0,-1)),e.endsWith(`
`)&&(e=e.slice(0,-1))),m.prototype.equals.call(this,n,e,t)};var Oe=new m;Oe.tokenize=function(n){return n.split(/(\S.+?[.!?])(?=\s+|$)/)};var Se=new m;Se.tokenize=function(n){return n.split(/([{}:;,]|\s+)/)};function B(n){"@babel/helpers - typeof";return B=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},B(n)}var I=new m;I.useLongestToken=!0;I.tokenize=X.tokenize;I.castInput=function(n,e){var t=e.undefinedReplacement,r=e.stringifyReplacer,i=r===void 0?function(o,s){return typeof s>"u"?t:s}:r;return typeof n=="string"?n:JSON.stringify(G(n,null,null,i),i,"  ")};I.equals=function(n,e,t){return m.prototype.equals.call(I,n.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"),t)};function G(n,e,t,r,i){e=e||[],t=t||[],r&&(n=r(i,n));var o;for(o=0;o<e.length;o+=1)if(e[o]===n)return t[o];var s;if(Object.prototype.toString.call(n)==="[object Array]"){for(e.push(n),s=new Array(n.length),t.push(s),o=0;o<n.length;o+=1)s[o]=G(n[o],e,t,r,i);return e.pop(),t.pop(),s}if(n&&n.toJSON&&(n=n.toJSON()),B(n)==="object"&&n!==null){e.push(n),s={},t.push(s);var a=[],u;for(u in n)Object.prototype.hasOwnProperty.call(n,u)&&a.push(u);for(a.sort(),o=0;o<a.length;o+=1)u=a[o],s[u]=G(n[u],e,t,r,u);e.pop(),t.pop()}else s=n;return s}var Q=new m;Q.tokenize=function(n){return n.slice()};Q.join=Q.removeEmpty=function(n){return n};var w=require("obsidian");var k=require("obsidian");var x=require("obsidian"),O={"gpt-4.1-nano":{displayText:"GPT 4.1 nano (recommended)",maxOutputTokens:32768,costPerMillionTokens:{input:.1,output:.4},info:{intelligence:2,speed:5,url:"https://platform.openai.com/docs/models/gpt-4.1-nano"}},"gpt-4.1-mini":{displayText:"GPT 4.1 mini",maxOutputTokens:32768,costPerMillionTokens:{input:.4,output:1.6},info:{intelligence:3,speed:4,url:"https://platform.openai.com/docs/models/gpt-4.1-mini"}},"gpt-4.1":{displayText:"GPT 4.1 (for tasks beyond proofreading)",maxOutputTokens:32768,costPerMillionTokens:{input:2,output:8},info:{intelligence:4,speed:3,url:"https://platform.openai.com/docs/models/gpt-4.1"}}},q={openAiApiKey:"",openAiModel:"gpt-4.1-nano",staticPrompt:"Act as a professional editor. Please make suggestions how to improve clarity, readability, grammar, and language of the following text. Preserve the original meaning and any technical jargon. Suggest structural changes only if they significantly improve flow or understanding. Avoid unnecessary expansion or major reformatting (e.g., no unwarranted lists). Try to make as little changes as possible, refrain from doing any changes when the writing is already sufficiently clear and concise. Output only the revised text and nothing else. The text is:",preserveTextInsideQuotes:!1,preserveBlockquotes:!1},$=class extends x.PluginSettingTab{plugin;constructor(e){super(e.app,e),this.plugin=e}display(){let{containerEl:e}=this,t=this.plugin.settings;e.empty(),new x.Setting(e).setName("OpenAI API key").addText(r=>{r.inputEl.type="password",r.inputEl.setCssProps({width:"100%"}),r.setPlaceholder("sk-123456789\u2026").setValue(t.openAiApiKey).onChange(async i=>{t.openAiApiKey=i.trim(),await this.plugin.saveSettings()})}),new x.Setting(e).setName("Model").setDesc("The nano model is slightly quicker and cheaper. The mini model is slightly higher quality, but also more expensive. Other models are both slower and more expensive; they should only be selected by advanced users who customize the prompt and intend to use this plugin for tasks beyond proofreading.").addDropdown(r=>{for(let i in O){if(!Object.hasOwn(O,i))continue;let o=O[i].displayText;r.addOption(i,o)}r.setValue(t.openAiModel).onChange(async i=>{t.openAiModel=i,await this.plugin.saveSettings()})}),new x.Setting(e).setName("Preserve text inside quotes").setDesc('No changes will be made to text inside quotation marks ("").Note that this prevention is not perfect, as the AI will sometimes suggest changes across quotes.').addToggle(r=>r.setValue(t.preserveTextInsideQuotes).onChange(async i=>{t.preserveTextInsideQuotes=i,await this.plugin.saveSettings()})),new x.Setting(e).setName("Preserve text in blockquotes and callouts").setDesc("No changes will be made to lines beginning with `>`. Note that this prevention is not perfect, as the AI will sometimes suggest changes across quotes.").addToggle(r=>r.setValue(t.preserveBlockquotes).onChange(async i=>{t.preserveBlockquotes=i,await this.plugin.saveSettings()})),new x.Setting(e).setName("Advanced").setHeading(),new x.Setting(e).setName("System prompt").setDesc("The LLM must respond ONLY with the updated text for this plugin to work. Most users do not need to change this setting. Only change this if you know what you are doing.").addTextArea(r=>{r.inputEl.setCssProps({width:"25vw",height:"15em"}),r.setValue(t.staticPrompt).setPlaceholder("Make suggestions based on\u2026").onChange(async i=>{i.trim()!==""&&(t.staticPrompt=i.trim(),await this.plugin.saveSettings())})})}};var A=require("obsidian");function Y(n){if(A.Platform.isMobileApp)new A.Notice("Error. For details, run the respective function on the desktop.");else{let e=A.Platform.isMacOS?"cmd+opt+i":"ctrl+shift+i";new A.Notice(`Error. Check the console for more details (${e}).`),console.error("[Proofreader plugin] error",n)}}async function le(n,e){if(!n.openAiApiKey){new k.Notice("Please set your OpenAI API key in the plugin settings.");return}let t;try{t=await(0,k.requestUrl)({url:"https://api.openai.com/v1/chat/completions",method:"POST",contentType:"application/json",headers:{Authorization:"Bearer "+n.openAiApiKey},body:JSON.stringify({model:n.openAiModel,messages:[{role:"developer",content:n.staticPrompt},{role:"user",content:e}]})}),console.debug("[Proofreader plugin] OpenAI response",t)}catch(l){if(l.status===401){let f="OpenAI API key is not valid. Please verify the key in the plugin settings.";new k.Notice(f,6e3);return}Y(l);return}let r=t.json?.choices?.[0].message.content;if(!r){Y(t);return}let i=O[n.openAiModel],o=t.json?.usage?.completion_tokens||0,s=o>=i.maxOutputTokens,u=(t.json?.usage?.prompt_tokens||0)*i.costPerMillionTokens.input/1e6+o*i.costPerMillionTokens.output/1e6;return{newText:r,isOverlength:s,cost:u}}function be(n,e,t,r){let i=e.match(/^(\s*)/)?.[0]||"",o=e.match(/(\s*)$/)?.[0]||"";t=t.replace(/^(\s*)/,i).replace(/(\s*)$/,o);let s=se(e,t);r&&(s.at(-1).removed=!1,s.splice(-2,0,{added:!1,removed:!1,value:`

> [!INFO] End of proofreading
> The input text was too long. Text after this point is unchanged.

`}));let a=s.map(l=>!l.added&&!l.removed?l.value:(l.added?`==${l.value}==`:`~~${l.value}~~`).replace(/^(==|~~)(\s)/,"$2$1")).join("");a=a.replace(/~~\[\^\w+\]~~/g,"$1").replace(/~~"~~==[“”]==/g,'"').replace(/~~'~~==[‘’]==/g,"'").replace(/~~(.+?)(.{1,2})~~==(\1)==/g,"$1~~$2~~").replace(/~~(.+?)~~==(?:\1)(.{1,2})==/g,"$1==$2==").replace(/ {2}(?!$)/gm," "),n.preserveBlockquotes&&(a=a.replace(/^~~>~~/gm,">").replace(/^~~(>[^~=]*)~~$/gm,"$1").replace(/^>.*/gm,l=>F(l))),n.preserveTextInsideQuotes&&(a=a.replace(/"[^"]+"/g,l=>F(l)));let u=(a.match(/==|~~/g)?.length||0)/2;return{textWithSuggestions:a,changeCount:u}}async function ue(n,e,t){if(e.trim()===""){new w.Notice(`${t} is empty.`);return}if(e.match(/==|~~/)){let y=`${t} already has highlights or strikethroughs.

Please accept/reject the changes before making another proofreading request.`;new w.Notice(y,6e3);return}let{app:r,settings:i}=n,o=r.workspace.getActiveFile()?.path,s=e.length>1500,a=e.length>15e3,u=s?0:4e3,l=`\u{1F916} ${t} is being proofread\u2026`;s&&(l+=`

Due to the length of the text, this may take a moment.`,a&&(l+=" (A minute or longer.)"),l+=`

Do not go to a different file or change the original text in the meantime.`);let f=new w.Notice(l,0),{newText:c,isOverlength:v,cost:g}=await le(i,e)||{};if(f.hide(),!c)return;let p=r.workspace.getActiveFile()?.path;if(o!==p){let y="\u26A0\uFE0F The active file changed since the proofread has been triggered. Aborting.";new w.Notice(y,u);return}let{textWithSuggestions:h,changeCount:L}=be(i,e,c,v);if(h===e){new w.Notice("\u2705 Text is good, nothing to change.",u);return}if(v){let y=`Text is longer than the maximum output supported by the AI model.

Suggestions are thus only made until the cut-off point.`;new w.Notice(y,1e4)}let b=[`\u{1F916} ${L} change${L===1?"":"s"} made.`,"",`est. cost: $${g?.toFixed(4)}`].join(`
`);return new w.Notice(b,u),h}async function fe(n,e){let t=e.getValue(),r=(0,w.getFrontMatterInfo)(t).contentStart||0,i=t.length,o=t.slice(r),s=await ue(n,o,"Document");if(!s)return;let a=e.offsetToPos(r),u=e.offsetToPos(i);e.replaceRange(s,a,u),e.setCursor(a)}async function ce(n,e){if(e.listSelections().length>1){new w.Notice("Multiple selections are not supported.");return}let r=e.getCursor("from"),i=e.getSelection(),o=i||e.getLine(r.line),a=await ue(n,o,i?"Selection":"Paragraph");a&&(i?(e.replaceSelection(a),e.setCursor(r)):(e.setLine(r.line,a),e.setCursor({line:r.line,ch:0})))}var W=class extends de.Plugin{settings=q;async onload(){await this.loadSettings(),this.addSettingTab(new $(this)),this.addCommand({id:"proofread-selection-paragraph",name:"Proofread selection/paragraph",editorCallback:e=>ce(this,e),icon:"bot-message-square"}),this.addCommand({id:"proofread-full-document",name:"Proofread full document",editorCallback:e=>fe(this,e),icon:"bot-message-square"}),this.addCommand({id:"accept-suggestions-in-text",name:"Accept suggestions in selection/paragraph",editorCallback:e=>R(e,"accept"),icon:"check-check"}),this.addCommand({id:"reject-suggestions-in-text",name:"Reject suggestions in selection/paragraph",editorCallback:e=>R(e,"reject"),icon:"x"}),this.addCommand({id:"accept-next-suggestion",name:"Accept next suggestion (or go to suggestion if outside viewport)",editorCallback:e=>U(e,"accept"),icon:"check-check"}),this.addCommand({id:"reject-next-suggestion",name:"Reject next suggestion (or go to suggestion if outside viewport)",editorCallback:e=>U(e,"reject"),icon:"x"}),console.info(this.manifest.name+" Plugin loaded.")}onunload(){console.info(this.manifest.name+" Plugin unloaded.")}async saveSettings(){await this.saveData(this.settings)}async loadSettings(){this.settings=Object.assign({},q,await this.loadData()),!Object.keys(O).includes(this.settings.openAiModel)&&(this.settings.openAiModel=q.openAiModel,await this.saveSettings())}};

/* nosourcemap */